{% extends "base.html" %}

{% block title %}{{ location.name }} Count{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            <!-- Header -->
            <h2 class="card-title text-center mb-2">{{ location.name }} Count</h2>
            <p class="text-muted text-center mb-4">
                {% if not current_counts %}
                    Enter the initial count for each product.
                {% else %}
                    A first count has been submitted. Check items to submit corrections.
                {% endif %}
            </p>

            <!-- Product Type Filter Bar -->
            {% set product_types = products|map(attribute='type')|unique|sort %}
            {% include '_filter_bar.html' %}

            <!-- Count Form -->
            <form action="{{ url_for('submit_count', location_slug=location.name|replace(' ', '_')|lower) }}"
                  method="POST" id="count-form">

                <!-- Correction Mode Banner -->
                {% if current_counts %}
                <div class="alert alert-warning d-flex justify-content-between align-items-center mb-4" role="alert">
                    <div>
                        <h4 class="alert-heading">
                            <i class="fas fa-pencil-alt me-2"></i>Correction Mode
                        </h4>
                        <p class="mb-0">Only checked items with a new value will be updated.</p>
                    </div>
                    <div class="form-check form-switch fs-5">
                        <input class="form-check-input" type="checkbox" id="checkAll">
                        <label class="form-check-label" for="checkAll">Check All</label>
                    </div>
                </div>
                {% endif %}

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                {% if current_counts %}
                                    <th class="text-center" style="width: 10%;">Correct?</th>
                                {% endif %}
                                <th>Product</th>
                                <th class="d-none">Type</th>
                                <th style="width: 25%;">Count</th>
                                {# NEW: Display Expected and Variance Headings #}
                                <th style="width: 15%;">Expected</th>
                                <th style="width: 15%;">Variance</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                                {% set is_locked = false %}
                                {% set latest_count_for_product = current_counts.get(product.id) %}
                                {% if latest_count_for_product %}
                                    {% set first_count = first_counts.get(product.id) %}
                                    {% if first_count and first_count.user_id == current_user.id %}
                                        {% set is_locked = true %}
                                    {% endif %}
                                {% endif %}

                                <!-- Table Row -->
                                <tr {% if is_locked %}
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="left"
                                        title="A different user must submit corrections for counts you entered."
                                    {% endif %}>
                                    {% if current_counts %}
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fs-5 correction-checkbox"
                                                   type="checkbox"
                                                   name="correct_{{ product.id }}"
                                                   id="correct_{{ product.id }}"
                                                   {% if is_locked %}disabled{% endif %}>
                                        </div>
                                    </td>
                                    {% endif %}

                                    <td class="fw-bold product-name">{{ product.name }}</td>
                                    <td class="d-none product-type">{{ product.type }}</td>
                                    <td>
                                        {% set unit = product.unit_of_measure|lower %}
                                        {% set step = '0.01' if 'kg' in unit or 'l' in unit else '1' %}
                                        <div class="input-group">
                                            <input type="number" class="form-control count-input"
                                                   name="product_{{ product.id }}"
                                                   min="0"
                                                   step="{{ step }}"
                                                   value="{{ latest_count_for_product.amount if latest_count_for_product else '' }}"
                                                   {% if current_counts %}disabled{% endif %}
                                                   {% if is_locked %}disabled{% endif %}>
                                            <span class="input-group-text">{{ product.unit_of_measure }}</span>
                                        </div>
                                    </td>
                                    {# NEW: Display Expected and Variance Values (read-only) #}
                                    <td>
                                        <input type="text" class="form-control" 
                                               value="{{ latest_count_for_product.expected_amount|round(2) if latest_count_for_product and latest_count_for_product.expected_amount is not none else 'N/A' }}" 
                                               readonly>
                                    </td>
                                    <td>
                                        {% if latest_count_for_product and latest_count_for_product.variance_amount is not none %}
                                            {% set variance = latest_count_for_product.variance_amount|round(2) %}
                                            {% if variance > 0 %}
                                                <input type="text" class="form-control text-success fw-bold" value="+{{ variance }}" readonly>
                                            {% elif variance < 0 %}
                                                <input type="text" class="form-control text-danger fw-bold" value="{{ variance }}" readonly>
                                            {% else %}
                                                <input type="text" class="form-control text-muted" value="0" readonly>
                                            {% endif %}
                                        {% else %}
                                            <input type="text" class="form-control text-muted" value="N/A" readonly>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="text" class="form-control comment-input"
                                               name="comment_{{ product.id }}"
                                               value="{{ latest_count_for_product.comment if latest_count_for_product else '' }}"
                                               {% if current_counts %}disabled{% endif %}
                                               {% if is_locked %}disabled{% endif %}>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Hidden field for submit type -->
                <input type="hidden" name="submit_type" id="submit-type" value="">

                <!-- Submit Buttons -->
                <div class="d-grid mt-4">
                    {% if not current_counts %}
                        <button type="submit" class="btn btn-primary btn-lg">Submit First Count</button>
                    {% else %}
                        <button type="submit" class="btn btn-warning btn-lg"
                                id="submit-button" disabled>Submit Corrections</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const countForm = document.getElementById('count-form');
    const submitTypeInput = document.getElementById('submit-type');
    const isCorrectionMode = document.querySelector('.correction-checkbox') !== null;

    if (isCorrectionMode) {
        submitTypeInput.value = 'corrections_count';
        const submitButton = document.getElementById('submit-button');
        const checkboxes = document.querySelectorAll('.correction-checkbox');
        const checkAll = document.getElementById('checkAll');

        const toggleRowInputs = (row, isEnabled) => {
            row.querySelector('.count-input').disabled = !isEnabled;
            row.querySelector('.comment-input').disabled = !isEnabled;
            // Also enable/disable the submit button if relevant inputs are enabled
            updateSubmitButtonState(); 
        };

        const updateSubmitButtonState = () => {
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            submitButton.disabled = !anyChecked;
        };

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const row = e.target.closest('tr');
                toggleRowInputs(row, e.target.checked);
                updateSubmitButtonState();
            });
        });

        if (checkAll) {
            checkAll.addEventListener('change', (e) => {
                checkboxes.forEach(cb => {
                    // Only toggle if the checkbox itself is not disabled (e.g., due to self-correction lock)
                    if (!cb.disabled) { 
                        cb.checked = e.target.checked;
                        const row = cb.closest('tr');
                        toggleRowInputs(row, e.target.checked);
                    }
                });
                updateSubmitButtonState();
            });
        }
    } else {
        submitTypeInput.value = 'first_count';
    }

    if (countForm) {
        countForm.addEventListener('submit', function() {
            countForm.querySelectorAll('input, select').forEach(input => {
                input.disabled = false; // Ensure all fields are enabled for submission
            });
        });
    }
});
</script>
{% endblock scripts %}
{% endblock %}