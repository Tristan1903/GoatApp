{% extends "base.html" %}

{% block title %}Edit Recipe{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <h2 class="card-title mb-2">Edit Recipe: {{ recipe.name }}</h2>
                    <p class="text-muted mb-4">Update the recipe details below.</p>
                    <form action="{{ url_for('edit_recipe', recipe_id=recipe.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="name" class="form-label">Recipe Name</label>
                            <input type="text" id="name" name="name" class="form-control" value="{{ recipe.name }}" required>
                        </div>
                        
                        {# --- NEW INGREDIENT MANAGEMENT SECTION --- #}
                        <h5 class="mt-4 mb-3">Ingredients</h5>
                        <div id="ingredients-container">
                            {% if existing_ingredients %}
                                {% for ingredient in existing_ingredients %}
                                <div class="input-group mb-2 ingredient-row">
                                    <select class="form-select ingredient-select" name="ingredient_id[]" required>
                                        <option value="" disabled>Select an ingredient product...</option>
                                        {% for product in products %}
                                            <option value="{{ product.id }}" {% if product.id == ingredient.product_id %}selected{% endif %}>
                                                {{ product.name }} ({{ product.unit_of_measure }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <input type="number" step="0.01" min="0" class="form-control quantity-input" name="quantity[]" placeholder="Quantity" value="{{ ingredient.quantity }}" required>
                                    <button type="button" class="btn btn-outline-danger remove-ingredient"><i class="fas fa-trash"></i></button>
                                </div>
                                {% endfor %}
                            {% else %}
                                {# Default empty row if no existing ingredients #}
                                <div class="input-group mb-2 ingredient-row">
                                    <select class="form-select ingredient-select" name="ingredient_id[]" required>
                                        <option value="" disabled selected>Select an ingredient product...</option>
                                        {% for product in products %}<option value="{{ product.id }}">{{ product.name }} ({{ product.unit_of_measure }})</option>{% endfor %}
                                    </select>
                                    <input type="number" step="0.01" min="0" class="form-control quantity-input" name="quantity[]" placeholder="Quantity" required>
                                    <button type="button" class="btn btn-outline-danger remove-ingredient"><i class="fas fa-trash"></i></button>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-outline-secondary btn-sm mt-2"><i class="fas fa-plus"></i> Add Another Ingredient</button>
                        {# --- END NEW INGREDIENT MANAGEMENT SECTION --- #}

                        <div class="mb-3 mt-4">
                            <label for="instructions" class="form-label">Instructions</label>
                            <textarea id="instructions" name="instructions" class="form-control" rows="6" required>{{ recipe.instructions }}</textarea>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('recipes') }}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Recipe</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsContainer = document.getElementById('ingredients-container');
    const addIngredientBtn = document.getElementById('add-ingredient-btn');
    const productOptionsHtml = `
        {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }} ({{ product.unit_of_measure }})</option>
        {% endfor %}
    `;

    function addIngredientRow(selectedProductId = '', quantity = '') {
        const newRow = document.createElement('div');
        newRow.className = 'input-group mb-2 ingredient-row';
        newRow.innerHTML = `
            <select class="form-select ingredient-select" name="ingredient_id[]" required>
                <option value="" disabled selected>Select an ingredient product...</option>
                ${productOptionsHtml}
            </select>
            <input type="number" step="0.01" min="0" class="form-control quantity-input" name="quantity[]" placeholder="Quantity" required value="${quantity}">
            <button type="button" class="btn btn-outline-danger remove-ingredient"><i class="fas fa-trash"></i></button>
        `;
        ingredientsContainer.appendChild(newRow);

        const selectElement = newRow.querySelector('.ingredient-select');
        if (selectedProductId) {
            selectElement.value = String(selectedProductId);
        }

        // Attach change handler to update options when user picks a product in this new select
        selectElement.addEventListener('change', refreshOptions);
        
        // After adding, refresh all dropdowns to disable the newly selected item in others
        refreshOptions();
    }

    // Function to get all currently selected product IDs across all dropdowns
    function getSelectedProductIds() {
        return Array.from(ingredientsContainer.querySelectorAll('.ingredient-select'))
            .map(select => select.value)
            .filter(value => value && value !== ''); // Filter out empty or placeholder values
    }

    // Function to refresh options in all dropdowns
    function refreshOptions() {
        const selectedIds = getSelectedProductIds(); // Get current selections
        
        ingredientsContainer.querySelectorAll('.ingredient-select').forEach(select => {
            const currentValue = select.value; // Store the current value of this specific dropdown

            // Rebuild options from the original full list to have a clean slate
            select.innerHTML = `<option value="" disabled selected>Select an ingredient product...</option>` + productOptionsHtml;

            // Try to re-set the current value if it was a valid selection
            if (currentValue && selectedIds.includes(currentValue)) { // Check if the current value is still among selected (i.e., this is its owner)
                select.value = currentValue;
            } else {
                // If the current value is no longer valid (e.g., deleted or taken by another select),
                // reset to placeholder. This helps if an option was removed by another select.
                select.value = ''; 
                select.querySelector('option[value=""]').selected = true;
            }


            // Now, disable/remove options that are selected in other dropdowns
            selectedIds.forEach(selectedId => {
                // Only touch options that are not the current dropdown's own selection
                if (selectedId !== currentValue) {
                    const optionToDisable = select.querySelector(`option[value="${selectedId}"]`);
                    if (optionToDisable) {
                        optionToDisable.remove(); // Disable the option
                        // Or remove: optionToDisable.remove(); (Disabling is usually better UX)
                    }
                }
            });
        });
    }

    // --- LOGIC FOR INITIAL SETUP AND RESTORING FORM DATA ---
    const oldIngredients = {{ request.form.getlist('ingredient_id[]') | tojson | safe }};
    const oldQuantities = {{ request.form.getlist('quantity[]') | tojson | safe }};

    if (oldIngredients.length > 0) {
        // If there's old form data (e.g., after a validation error), restore it
        ingredientsContainer.innerHTML = ''; // Clear any existing placeholders
        oldIngredients.forEach((id, index) => {
            addIngredientRow(id, oldQuantities[index] || '');
        });
    } else {
        // If no old form data, ensure there's at least one empty row initially.
        if (ingredientsContainer.children.length === 0) {
            addIngredientRow(); 
        }
    }
    // Initial refresh after all initial rows are set up
    refreshOptions(); 
    // --- END LOGIC ---

    // Event listener for the "Add Another Ingredient" button
    if (addIngredientBtn && !addIngredientBtn.dataset.bound) {
        addIngredientBtn.addEventListener('click', () => addIngredientRow());
        addIngredientBtn.dataset.bound = 'true';
    }

    // Event delegation for remove buttons
    ingredientsContainer.addEventListener('click', function(event) {
        if (event.target.closest('.remove-ingredient')) {
            const rowToRemove = event.target.closest('.ingredient-row');
            if (!rowToRemove) return;

            if (ingredientsContainer.children.length > 1) { 
                rowToRemove.remove();
            } else {
                const lastRowSelect = rowToRemove.querySelector('.ingredient-select');
                const lastRowQuantity = rowToRemove.querySelector('.quantity-input');
                if (lastRowSelect) {
                    lastRowSelect.value = ''; 
                    lastRowSelect.querySelector('option[value=""]').selected = true;
                }
                if (lastRowQuantity) {
                    lastRowQuantity.value = '';
                }
            }
            // After removal/clearing, refresh options to ensure options become available again
            refreshOptions();
        }
    });

    // Also update options when an ingredient-select changes (for initial rows or restored rows)
    ingredientsContainer.querySelectorAll('.ingredient-select').forEach(select => {
        select.addEventListener('change', refreshOptions);
    });
});
</script>
{% endblock scripts %}
{% endblock %}